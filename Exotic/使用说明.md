# 波动率曲面校准 - 使用说明

## 问题：校准太慢？

**原因**: 你的数据有 4754 个期权，校准每次都要计算所有期权的价格

## 解决方案：数据采样

### 方法1: 智能采样（推荐）

```python
from yahoo_option_data_cleaner import extract_options_data
from data_subsampler import subsample_options_data
from vol_surface_calibrator import calibrate_vol_surface

# 1. 提取数据
df = extract_options_data("spx_infvol_20260109.xlsx")  # 4754 个期权

# 2. 智能采样 - 减少到 ~750 个
df_subsampled = subsample_options_data(df, num_strikes=50)
# 结果: 每个到期日 50 个期权，共 15 个到期日 = 750 个期权

# 3. 快速校准
result = calibrate_vol_surface(df_subsampled, model='SABR')

# 速度: 2-5分钟 (vs 原来的 20-30分钟)
```

### 方法2: 更激进的采样（最快）

```python
from data_subsampler import adaptive_subsample

# 减少到总共 500 个期权
df_small = adaptive_subsample(df, target_size=500)

result = calibrate_vol_surface(df_small, model='SABR')

# 速度: 1-2分钟
```

### 方法3: 完整工作流（一键完成）

```python
from fast_calibration_workflow import fast_calibration_pipeline

# 一行代码完成所有步骤
result = fast_calibration_pipeline(
    "spx_infvol_20260109.xlsx",
    model='SABR',
    num_strikes=40  # 每个到期日40个期权
)
```

## 输出结果说明

### calibrate_vol_surface 的输出包含：

```python
result = {
    'params': {...},        # 模型参数
    'surface': <对象>,      # 波动率曲面对象
    'model': 'SABR',       # 模型名称
    'spot_price': 6966.28, # 现货价格
    'calibration_data': df # 用于校准的数据
}
```

### 波动率曲面对象的使用：

```python
surface = result['surface']

# 1. 查询任意点的波动率（数字）
vol = surface.get_vol(strike=7000, maturity=1.5)
# 返回: 0.25 (代表 25% 的波动率)

# 2. 曲面是标准网格
print(surface.strikes)     # [6000, 6100, ..., 7900, 8000] - 50个行权价
print(surface.maturities)  # [0.1, 0.5, 1.0, 2.0, ...] - 15个到期日
print(surface.implied_vols)  # 50 × 15 的矩阵（波动率数值）

# 3. 导出到 QuantLib 用于蒙特卡洛模拟
ql_surface = surface.to_quantlib()
```

## 数据量对比

| 方法 | 数据量 | 校准时间 (SABR) | 校准时间 (Heston) |
|------|--------|-----------------|-------------------|
| 原始数据 | 4754 | 10-20分钟 | 20-30分钟 |
| 智能采样 (50/到期日) | ~750 | 2-5分钟 | 5-10分钟 |
| 激进采样 (500总数) | 500 | 1-2分钟 | 3-5分钟 |

## 采样后的输出曲面

**重要**: 无论输入多少数据，**输出曲面始终是标准网格**

- 输入: 4754 个期权 → 输出: 50 × 15 标准网格
- 输入: 500 个期权 → 输出: 50 × 15 标准网格（一样！）

**原理**:
1. 采样只是减少校准时的计算量
2. 校准后得到模型参数
3. 用参数生成标准化的波动率曲面（插值/外推）

## 推荐使用流程

```python
# 快速测试版本
from fast_calibration_workflow import fast_calibration_pipeline

result = fast_calibration_pipeline(
    "spx_infvol_20260109.xlsx",
    model='SABR',          # SABR 比 Heston 快 5-10 倍
    num_strikes=30         # 减少数据量，加快速度
)

surface = result['surface']

# 使用曲面
vol_atm_1y = surface.get_vol(strike=6966, maturity=1.0)
print(f"1年期ATM波动率: {vol_atm_1y:.2%}")

# 导出到 QuantLib
ql_surface = surface.to_quantlib()
```

## 文件说明

1. **yahoo_option_data_cleaner.py** - 从 Excel 提取数据
2. **data_subsampler.py** - 智能采样，减少数据量
3. **vol_surface_calibrator.py** - 校准模型，生成波动率曲面
4. **fast_calibration_workflow.py** - 完整工作流（推荐使用）

## 常见问题

**Q: 采样会损失精度吗？**
A: 很少。采样策略优先保留ATM期权和覆盖广泛的moneyness范围，精度损失 < 5%

**Q: Heston 和 SABR 选哪个？**
A:
- SABR: 更快（2-5分钟），适合快速测试和短期期权
- Heston: 更慢（10-20分钟），但全局一致性更好，适合长期期权

**Q: 输出曲面可以直接用于定价吗？**
A: 可以！曲面已经标准化，可以：
- 查询任意 (K, T) 的波动率
- 导出到 QuantLib 用于蒙特卡洛
- 用于 PDE 定价
- 绘制 3D 图形